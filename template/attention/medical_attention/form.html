{% extends "components/base.html" %}
{% load static %}
{% block css%}
<style>
    .form-floating > label {
        padding: 0.5rem 0.75rem;
    }
    .form-floating > .form-control,
    .form-floating > .form-select {
        height: 3.5rem;
        line-height: 1.25;
    }
    .form-floating > textarea.form-control {
        height: auto;
        min-height: 100px;
    }
    .card {
        border-radius: 15px;
        border: none;
    }
    .section-title {
        color: #2563eb;
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
    }
    .btn-primary {
        background-color: #2563eb;
        border-color: #2563eb;
        padding: 0.625rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
    }
    .btn-primary:hover {
        background-color: #1d4ed8;
        border-color: #1d4ed8;
    }
    .form-control:focus, .form-select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
    }
    </style>
{% endblock %}

{% block content %}
<title>{% block title %}Registrar Atención Médica{% endblock title %}</title>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-xxl-10">
            <h3 class="text-center mb-2 fw-bold text-primary-emphasis shadow">
                {{ title1 }} Médica
            </h3>
            
            <div class="card shadow">
                <div class="card-body p-2 p-md-3">
                    <form id="frmAtencion" method="POST">
                        {% csrf_token %}
                        {{ form.media }}
                        
                        <!-- Información del Paciente -->
                        <h5 class="text-primary-emphasis fw-bold">Información del Paciente</h5>
                         <hr class="border border-2 border-success">
                        <div class="row g-4 mb-2">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.paciente }}
                                    <label for="{{ form.paciente.id_for_label }}">{{ form.paciente.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-floating">
                                    {{ form.peso }}
                                    <label for="{{ form.peso.id_for_label }}">{{ form.peso.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-floating">
                                    {{ form.altura }}
                                    <label for="{{ form.altura.id_for_label }}">{{ form.altura.label }}</label>
                                </div>
                            </div>
                        </div>

                        <!-- Signos Vitales -->
                        <h5 class="text-primary-emphasis fw-bold">Signos Vitales</h5>
                        <hr class="border border-2 border-success">
                        <div class="row g-2 mb-2">
                            <div class="col-md-2">
                                <div class="form-floating">
                                    {{ form.presion_arterial }}
                                    <label for="{{ form.presion_arterial.id_for_label }}">{{ form.presion_arterial.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-floating">
                                    {{ form.pulso }}
                                    <label for="{{ form.pulso.id_for_label }}">{{ form.pulso.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-floating">
                                    {{ form.temperatura }}
                                    <label for="{{ form.temperatura.id_for_label }}">{{ form.temperatura.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-floating">
                                    {{ form.saturacion_oxigeno }}
                                    <label for="{{ form.saturacion_oxigeno.id_for_label }}">{{ form.saturacion_oxigeno.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-floating">
                                    {{ form.frecuencia_respiratoria }}
                                    <label for="{{ form.frecuencia_respiratoria.id_for_label }}">{{ form.frecuencia_respiratoria.label }}</label>
                                </div>
                            </div>
                        </div>

                        <!-- Evaluación Médica -->
                        <h5 class="text-primary-emphasis fw-bold">Evaluación Médica</h5>
                         <hr class="border border-2 border-success">

                        <div class="row g-4 mb-2">
                            <div class="col-md-12">
                                <div class="form-floating">
                                    {{ form.motivo_consulta }}
                                    <label for="{{ form.motivo_consulta.id_for_label }}">{{ form.motivo_consulta.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.sintomas }}
                                    <label for="{{ form.sintomas.id_for_label }}">{{ form.sintomas.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.examen_fisico }}
                                    <label for="{{ form.examen_fisico.id_for_label }}">{{ form.examen_fisico.label }}</label>
                                </div>
                            </div>
                        </div>

                        <!-- Diagnóstico y Tratamiento -->
                        <h5 class="text-primary-emphasis fw-bold">Diagnóstico y Tratamiento</h5>
                         <hr class="border border-2 border-success">
                        <div class="row g-4 mb-2">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.diagnostico }}
                                    <label for="{{ form.diagnostico.id_for_label }}">{{ form.diagnostico.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.tratamiento }}
                                    <label for="{{ form.tratamiento.id_for_label }}">{{ form.tratamiento.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.examenes_enviados }}
                                    <label for="{{ form.examenes_enviados.id_for_label }}">{{ form.examenes_enviados.label }}</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.comentario_adicional }}
                                    <label for="{{ form.comentario_adicional.id_for_label }}">{{ form.comentario_adicional.label }}</label>
                                </div>
                            </div>
                        </div>

                     
                    </form>
                     <!-- Información de medicmentos y prescripcion -->
                     <<!-- Medications Section -->
                    <h5 class="text-primary-emphasis fw-bold">Medicamentos y Prescripción</h5>
                    <hr class="border border-3 border-danger fw-bold">
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <div class="form-floating">
                               <select class="form-select" id="medicationSelect">
                                  {% for item in medications %}
                                    <option value="{{item.id}}" data-id="{{item.id}}" data-des="{{item.nombre}}">{{item.nombre}}</option>
                                  {% endfor %}
                                </select>
                                 <label for="medicationSelect" class="form-label">Medicamento</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating">
                                  <input type="number" class="form-control" value="1" id="medicationQuantity" min="1">
                                  <label for="medicationQuantity" class="form-label">Cantidad</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                  <input type="text" class="form-control" id="medicationPrescription">
                                  <label for="medicationPrescription">Prescripción</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating mt-2 ms-2">
                                <button type="button" class="btn btn-outline-success fw-bold w-100" onclick="addMedication()">
                                    Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="medicationsTable">
                            <thead>
                                <tr>
                                    <th class="text-warning">Código</th>
                                    <th class="text-success">Medicamento</th>
                                    <th class="text-primary">Cantidad</th>
                                    <th class="text-danger-emphasis fw-bold">Prescripción</th>
                                    <th class="text-danger">Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Examinations Section -->
                    <h5 class="text-primary-emphasis fw-bold mt-4">Exámenes Médicos</h5>
                    <hr class="border border-3 border-info fw-bold">
                    <div class="row g-3 mb-2">
                        <div class="col-md-4">
                            <div class="form-floating">
                               <select class="form-select" id="examenSelect">
                                  {% for item in examenes %}
                                    <option value="{{item.id}}" data-id="{{item.id}}" data-des="{{item.tipo_examen}}">{{item.tipo_examen}} - {{item.descripcion}}</option>
                                  {% endfor %}
                                </select>
                                <label for="examenSelect" class="form-label">Examen</label>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="examenResultado" placeholder="Resultado">
                                <label for="examenResultado">Resultado</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating mt-2 ms-2">
                                <button type="button" class="btn btn-outline-info fw-bold w-100" onclick="addExamen()">
                                    Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="examenesTable">
                            <thead>
                                <tr>
                                    <th class="text-warning">Código</th>
                                    <th class="text-success">Examen</th>
                                    <th class="text-primary">Resultado</th>
                                    <th class="text-danger">Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Additional Services Section -->
                    <h5 class="text-primary-emphasis fw-bold mt-4">Servicios Adicionales</h5>
                    <hr class="border border-3 border-success fw-bold">
                    <div class="row g-3 mb-2">
                        <div class="col-md-4">
                            <div class="form-floating">
                               <select class="form-select" id="servicioSelect">
                                  {% for item in servicios %}
                                    <option value="{{item.id}}" data-id="{{item.id}}" data-des="{{item.nombre_servicio}}">{{item.nombre_servicio}}</option>
                                  {% endfor %}
                                </select>
                                <label for="servicioSelect" class="form-label">Servicio</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="number" class="form-control" value="1" id="servicioQuantity" min="1">
                                <label for="servicioQuantity" class="form-label">Cantidad</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating mt-2 ms-2">
                                <button type="button" class="btn btn-outline-success fw-bold w-100" onclick="addServicio()">
                                    Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="serviciosTable">
                            <thead>
                                <tr>
                                    <th class="text-warning">Código</th>
                                    <th class="text-success">Servicio</th>
                                    <th class="text-primary">Cantidad</th>
                                    <th class="text-danger">Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-end mt-4 gap-2">
                        <button type="button" onclick="atencionMedica.saveAtencion()" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar
                        </button>
                        <a class="btn btn-success" href="{% url 'attention:attention_list'%}">Cancelar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="detail_atencion" value="{{ detail_atencion|safe }}">
<input type="hidden" id="detail_examenes" value="{{ detail_examenes|safe }}">
<input type="hidden" id="detail_servicios" value="{{ detail_servicios|safe }}">
</div>
{% endblock %}
{% block js %}
 <script>
// Inicialización de la clase para manejar la atención médica
class AtencionMedica {
    constructor(detalleAtencion, detalleExamenes, detalleServicios) {
        this.medicamentos = [];
        this.examenes = [];
        this.servicios = [];

        // Inicializar con datos existentes si los hay
        if (detalleAtencion && detalleAtencion.length > 0) {
            this.medicamentos = detalleAtencion.map(det => ({
                codigo: det.medicamento_id,
                nombre: det.medicamento__nombre,
                cantidad: det.cantidad,
                prescripcion: det.prescripcion
            }));
        }

        if (detalleExamenes && detalleExamenes.length > 0) {
            this.examenes = detalleExamenes.map(det => ({
                codigo: det.examen_id,
                nombre: det.examen__tipo_examen,
                resultado: det.resultado
            }));
        }

        if (detalleServicios && detalleServicios.length > 0) {
            this.servicios = detalleServicios.map(det => ({
                codigo: det.servicio_id,
                nombre: det.servicio__nombre_servicio,
                cantidad: det.cantidad
            }));
        }

        // Inicializar las tablas
        this.syncTable('medicamentos');
        this.syncTable('examenes');
        this.syncTable('servicios');

        // Vincular métodos al objeto
        this.addMedication = this.addMedication.bind(this);
        this.addExamen = this.addExamen.bind(this);
        this.addServicio = this.addServicio.bind(this);
        this.saveAtencion = this.saveAtencion.bind(this);
    }

    addMedication() {
        const select = document.querySelector('#medicationSelect');
        const codigo = select.value;
        const nombre = select.options[select.selectedIndex].text;
        const cantidad = parseInt(document.querySelector('#medicationQuantity').value);
        const prescripcion = document.querySelector('#medicationPrescription').value;

        if (!prescripcion.trim()) {
            alert('La prescripción es requerida');
            return;
        }

        this.addItem('medicamentos', {
            codigo,
            nombre,
            cantidad,
            prescripcion
        });

        // Limpiar campos
        document.querySelector('#medicationQuantity').value = '1';
        document.querySelector('#medicationPrescription').value = '';
    }

    addExamen() {
        const select = document.querySelector('#examenSelect');
        const codigo = select.value;
        const nombre = select.options[select.selectedIndex].text;
        const resultado = document.querySelector('#examenResultado').value;

        if (!resultado.trim()) {
            alert('El resultado es requerido');
            return;
        }

        this.addItem('examenes', {
            codigo,
            nombre,
            resultado
        });

        document.querySelector('#examenResultado').value = '';
    }

    addServicio() {
        const select = document.querySelector('#servicioSelect');
        const codigo = select.value;
        const nombre = select.options[select.selectedIndex].text;
        const cantidad = parseInt(document.querySelector('#servicioQuantity').value);

        this.addItem('servicios', {
            codigo,
            nombre,
            cantidad
        });

        document.querySelector('#servicioQuantity').value = '1';
    }

    addItem(type, data) {
        const collections = {
            medicamentos: this.medicamentos,
            examenes: this.examenes,
            servicios: this.servicios
        };

        const collection = collections[type];
        const existingIndex = collection.findIndex(item => item.codigo === data.codigo);

        if (existingIndex >= 0) {
            if (type === 'medicamentos' || type === 'servicios') {
                collection[existingIndex].cantidad += data.cantidad;
            } else {
                collection[existingIndex] = data;
            }
        } else {
            collection.push(data);
        }

        this.syncTable(type);
    }

    removeItem(type, codigo) {
        const collections = {
            medicamentos: this.medicamentos,
            examenes: this.examenes,
            servicios: this.servicios
        };

        collections[type] = collections[type].filter(item => item.codigo !== codigo);
        this[type] = collections[type];
        this.syncTable(type);
    }

    syncTable(type) {
        const tableIds = {
            medicamentos: 'medicationsTable',
            examenes: 'examenesTable',
            servicios: 'serviciosTable'
        };

        const tableBody = document.querySelector(`#${tableIds[type]} tbody`);
        if (!tableBody) return;

        tableBody.innerHTML = '';
        const items = this[type];

        items.forEach(item => {
            const row = document.createElement('tr');
            
            // Código
            row.innerHTML += `<td>${item.codigo}</td>`;
            // Nombre
            row.innerHTML += `<td>${item.nombre}</td>`;
            
            // Cantidad o Resultado
            if (type === 'examenes') {
                row.innerHTML += `<td>${item.resultado}</td>`;
            } else {
                row.innerHTML += `<td>${item.cantidad}</td>`;
            }

            // Prescripción (solo para medicamentos)
            if (type === 'medicamentos') {
                row.innerHTML += `<td>${item.prescripcion}</td>`;
            }

            // Botón eliminar
            row.innerHTML += `
                <td>
                    <button class="btn btn-danger" onclick="atencionMedica.removeItem('${type}', '${item.codigo}')">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </td>
            `;

            tableBody.appendChild(row);
        });
    }

    saveAtencion() {
        // Capturar datos del formulario
        const formData = {
            paciente: document.querySelector('#id_paciente').value,
            peso: document.querySelector('#id_peso').value,
            altura: document.querySelector('#id_altura').value,
            presionArterial: document.querySelector('#id_presion_arterial').value,
            pulso: document.querySelector('#id_pulso').value,
            temperatura: document.querySelector('#id_temperatura').value,
            saturacionOxigeno: document.querySelector('#id_saturacion_oxigeno').value,
            frecuenciaRespiratoria: document.querySelector('#id_frecuencia_respiratoria').value,
            motivoConsulta: document.querySelector('#id_motivo_consulta').value,
            sintomas: document.querySelector('#id_sintomas').value,
            examenFisico: document.querySelector('#id_examen_fisico').value,
            tratamiento: document.querySelector('#id_tratamiento').value,
            examenesEnviados: document.querySelector('#id_examenes_enviados').value,
            comentarioAdicional: document.querySelector('#id_comentario_adicional').value,
            diagnostico: Array.from(document.querySelector('#id_diagnostico').selectedOptions).map(opt => opt.value),
            medicamentos: this.medicamentos,
            examenes: this.examenes,
            servicios: this.servicios
        };

        // Validar campos requeridos
        const requiredFields = [
            'paciente', 'peso', 'altura', 'presionArterial', 'pulso', 
            'temperatura', 'saturacionOxigeno', 'frecuenciaRespiratoria',
            'motivoConsulta', 'sintomas', 'examenFisico', 'diagnostico',
            'tratamiento', 'examenesEnviados'
        ];

        const emptyFields = requiredFields.filter(field => !formData[field]);
        console.log(emptyFields);
        if (emptyFields.length > 0) {
            alert('Por favor, complete todos los campos obligatorios.');
            return;
        }

        if (this.medicamentos.length === 0) {
            alert('Por favor, agregue al menos un medicamento.');
            return;
        }

        // Enviar datos al backend
        fetch(window.location.pathname, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.msg) {
                alert(data.msg);
                window.location.href = '/attention/attention_list/';
            } else {
                alert('Error al guardar la atención médica');
            }
        })
        .catch(error => {
            console.error('Error al guardar la atención médica:', error);
            alert('Error al guardar la atención médica');
        });
    }
}

// Inicialización cuando el DOM está listo
document.addEventListener('DOMContentLoaded', function() {
    // Parsear los datos iniciales
    const detailAtencionUpdate = JSON.parse(document.getElementById('detail_atencion').textContent || '[]');
    const detailExamenesUpdate = JSON.parse(document.getElementById('detail_examenes').textContent || '[]');
    const detailServiciosUpdate = JSON.parse(document.getElementById('detail_servicios').textContent || '[]');

    // Crear instancia global
    window.atencionMedica = new AtencionMedica(
        detailAtencionUpdate,
        detailExamenesUpdate,
        detailServiciosUpdate
    );

    // Vincular eventos a los botones
    document.querySelector('[onclick="addMedication()"]').onclick = () => window.atencionMedica.addMedication();
    document.querySelector('[onclick="addExamen()"]').onclick = () => window.atencionMedica.addExamen();
    document.querySelector('[onclick="addServicio()"]').onclick = () => window.atencionMedica.addServicio();
});
</script>
{% endblock %}